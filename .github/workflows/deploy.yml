name: Deploy to Production Server

on:
  push:
    branches:
      - main

concurrency:
  group: eips-insight-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Notify Deployment Start
      - name: Notify Deployment Start
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "üöÄ Deployment Started"
          embed-description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            Deployment has started.
          embed-color: 16776960
          embed-footer-text: "GitHub Actions ‚Ä¢ Deployment Bot"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}

      # Step 3: Deploy via SSH (release-based, zero downtime)
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 45m
          command_timeout: 40m
          script: |
            set -e

            BASE_DIR=/root/eip-client/EIPsInsight
            RELEASES_DIR=$BASE_DIR/releases
            SHARED_DIR=$BASE_DIR/shared
            RELEASE_NAME=$(date +"%Y%m%d_%H%M%S")
            NEW_RELEASE=$RELEASES_DIR/$RELEASE_NAME

            echo "üì¶ Creating new release: $RELEASE_NAME"

            mkdir -p $RELEASES_DIR
            git clone -b main https://github.com/AvarchLLC/EIPsInsight.git $NEW_RELEASE

            # Inject environment variables
            if [ ! -f "$SHARED_DIR/.env.local" ]; then
              echo "‚ùå Missing .env.local in shared directory"
              exit 1
            fi

            ln -s $SHARED_DIR/.env.local $NEW_RELEASE/.env.local

            cd $NEW_RELEASE

            echo "üì¶ Using Node 18"
            source ~/.nvm/nvm.sh
            nvm use 18

            echo "üì• Installing dependencies"
            npm ci

            echo "üèóÔ∏è Building application"
            npm run build

            echo "üîÅ Switching release symlink"
            ln -sfn $NEW_RELEASE $BASE_DIR/current

            echo "‚ôªÔ∏è Reloading PM2"
            pm2 reload eips-insight

            echo "ü©∫ Running health check"
            sleep 5
            if ! curl -fs http://localhost:3000/api/health; then
              echo "‚ùå Health check failed, rolling back"

              PREVIOUS_RELEASE=$(ls -dt $RELEASES_DIR/* | sed -n '2p')
              if [ -n "$PREVIOUS_RELEASE" ]; then
                ln -sfn $PREVIOUS_RELEASE $BASE_DIR/current
                pm2 reload eips-insight
              fi

              exit 1
            fi

            echo "üßπ Cleaning old releases (keep last 3)"
            cd $RELEASES_DIR
            ls -dt */ | tail -n +4 | xargs rm -rf

            echo "‚úÖ Deployment completed successfully"

      # Step 4: Notify Discord on Success
      - name: Discord Notification - Success
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "‚úÖ Deployment Successful"
          embed-description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            üéâ Production updated successfully with zero downtime.
          embed-color: 3066993
          embed-footer-text: "GitHub Actions ‚Ä¢ Deployment Bot"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}

      # Step 5: Notify Discord on Failure
      - name: Discord Notification - Failure
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "‚ùå Deployment Failed"
          embed-description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            ‚ö†Ô∏è Deployment failed. Automatic rollback triggered.
          embed-color: 15158332
          embed-footer-text: "GitHub Actions ‚Ä¢ Deployment Bot"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}
